var Queue = require('bull');
var SpotifyWebApi = require('spotify-web-api-node');
var { getPlaylistTracks } = require('../utils/getAll');
var shuffleArray = require('../utils/shuffleArray');
var validUserCache = require('../utils/validUserCache');
var db = require('../db');
var { addPlaylistQueue } = require('./handleUpdate');

const handlePlaylistShuffle = new Queue('handle-playlist-shuffle');

handlePlaylistShuffle.process(async (job) => {
    const { uri, name, accessToken } = job.data;
    try {
        const playlistId = uri.split(':')[2];
        const spotifyApi = new SpotifyWebApi({ accessToken: accessToken });

        let trackUris = [];

        const res = await spotifyApi.getMe();
        const user = res.body;

        const userQueryRes = await db.query('SELECT * FROM public.user WHERE uri=$1', [user.uri]);

        // Fallback to Spotify Api for Track Uris if the database has invalid data
        // Or an error is thrown while attempting to get data from database
        try {
            if (validUserCache(userQueryRes)) {
                console.log(`${user.display_name} | Shuffle Playlist Utilize Database | ${new Date().toLocaleString()}`)
                const statement = `SELECT public.track_in_playlist.track_uri FROM public.track_in_playlist
                                    WHERE public.track_in_playlist.playlist_uri = $1
                                    AND public.track_in_playlist.track_uri NOT LIKE '%:local:%'`;
                const tracksRes = await db.query(statement, [uri]);
                trackUris = tracksRes.rows.map(row => row.track_uri);
            }
        } finally {
            if (trackUris.length === 0) {
                console.log(`${user.display_name} | Shuffle Playlist Utilize Spotify API | ${new Date().toLocaleString()}`)
                for await (let playlistTrack of getPlaylistTracks(playlistId, accessToken)) {
                    const { track } = playlistTrack;
                    if (!playlistTrack.is_local) {
                        // Local tracks are unable to be added to new playlists
                        trackUris.push(track.uri);
                    }
                }
            }
        }

        shuffleArray(trackUris);

        let newName = `True Shuffle: ${(name !== null && name !== undefined) ? name : playlistId}`;
        newName = newName.slice(0, 100); // Limit to 100 characters

        const description = "Generated by Spotify Playlist Manager (www.spotifyplaylistmanager.net). Remember to turn off the shuffle. Enjoy!";
        const newPlaylistRes = await spotifyApi.createPlaylist(newName, { public: true, description: description });
        const newPlaylist = newPlaylistRes.body;

        try {
            for (let i = 0; i < trackUris.length; i += 100) {
                const trackUriSlice = trackUris.slice(i, i + 100);
                await spotifyApi.addTracksToPlaylist(newPlaylist.id, trackUriSlice);
            }
            addPlaylistQueue.add({
                userUri: user.uri,
                playlistUri: newPlaylist.uri,
                trackUris: trackUris,
            });
        } catch (err) {
            // In the case that the playlist cannot be added to, delete the newly created playlist
            console.error(err);
            await spotifyApi.unfollowPlaylist(newPlaylist.id);
        }
    } catch (err) {
        console.error(err);
    }
});

module.exports = handlePlaylistShuffle;